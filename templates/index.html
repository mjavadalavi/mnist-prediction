<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNIST Dataset</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #canvas {
            border: 1px solid black;
            cursor: crosshair;
        }

        /* Disable button style */
        .disabled-btn {
            background-color: #dcdcdc !important;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mt-5">MNIST Dataset</h1>
        <div id="alert-container" class="mt-3"></div>

        <center>
            <canvas id="canvas" width="200" height="200" class="w-25 m-4"></canvas>
        </center>

        <div class="mt-3 d-flex">
            <button id="train-btn" class="btn btn-success w-100 m-2">Start Traning</button>
        </div>
        <div class="mt-3 d-flex">
            <button id="submit-btn" class="btn btn-primary w-50 m-2 disabled-btn" disabled>Predict</button>
            <button id="clear-btn" class="btn btn-secondary w-50 m-2 disabled-btn" disabled>Clear</button>
        </div>

        <div id="training-status" class="mt-3">
            <p id="status-message" class="text-center">Traning not start yeat.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let painting = false;
        let trainingUUID = null;

        function startPosition(e) {
            painting = true;
            draw(e);
        }

        function endPosition() {
            painting = false;
            ctx.beginPath();
        }

        function draw(e) {
            if (!painting) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.lineWidth = 10;
            ctx.lineCap = 'round';
            ctx.strokeStyle = 'black';

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', endPosition);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseout', endPosition);

        document.getElementById('clear-btn').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('output-container').classList.add('d-none');
            document.getElementById('alert-container').innerHTML = '';
        });

        function getProcessedImageData() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const threshold = 200;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                const brightness = (r + g + b) / 3;

                if (brightness > threshold) {
                    data[i] = 255;
                    data[i + 1] = 255;
                    data[i + 2] = 255;
                }
            }

            ctx.putImageData(imageData, 0, 0);
            return canvas.toDataURL('image/png');
        }

        document.getElementById('train-btn').addEventListener('click', async () => {
            try {
                // Disable all buttons during training
                toggleButtons(true);

                // Send request to start training
                const response = await fetch('/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ epochs: 5, batch_size: 128 })
                });
                const data = await response.json();

                if (response.ok){
                    trainingUUID = data.uuid;
                    document.getElementById('status-message').textContent = 'In progress ...';

                    // Start checking for training status
                    checkTrainingStatus();
                }else{
                    showErrorAlert(data.detail)
                    toggleButtons(false)

                    const trainBtn = document.getElementById('train-btn');
                    trainBtn.classList.add('disabled-btn');
                    trainBtn.disabled = true;
                }
            } catch (error) {
                alert('Error');
                toggleButtons(false);
            }
        });

        async function checkTrainingStatus() {
            try {
                const response = await fetch(`/train_status/${trainingUUID}`);
                const data = await response.json();
                if (response.ok){
                    if (data.status === 'Training finished') {
                        document.getElementById('status-message').textContent = 'Train Done.';
                        toggleButtons(false);  // Enable buttons again

                        const trainBtn = document.getElementById('train-btn');
                        trainBtn.classList.add('disabled-btn');
                        trainBtn.disabled = true;
                    } else if (data.status.includes('Error')) {
                        document.getElementById('status-message').textContent = 'Error on train: ' + data.status;
                        toggleButtons(false);  // Enable buttons again
                    } else {
                        document.getElementById('status-message').textContent = 'Train in progress. last status is: ' + data.status;
                        setTimeout(checkTrainingStatus, 5000); // Check status every 5 seconds
                    }
                }else{
                    showErrorAlert(data.detail)
                    toggleButtons(false);  // Enable buttons again

                    const trainbtn = document.getElementById('train-btn');
                    trainbtn.classList.add('disabled-btn');
                    trainbtn.disabled = true;
                }
            } catch (error) {
                document.getElementById('status-message').textContent = 'Error: ' + error;
                toggleButtons(false);
            }
        }

        function toggleButtons(disable) {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (disable) {
                    button.classList.add('disabled-btn');
                    button.disabled = true;
                } else {
                    button.classList.remove('disabled-btn');
                    button.disabled = false;
                }
            });
        }

        document.getElementById('submit-btn').addEventListener('click', async () => {
            const imageData = getProcessedImageData();

            const response = await fetch('predict/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image: imageData.split(',')[1] })
            });
            const data = await response.json();

            if (response.ok) {
                const predictedLabel = data.predicted_label;
                const inferenceTime = data.inference_time;

                showBootstrapAlert(predictedLabel, inferenceTime);
                
                const alertContainer = document.getElementById('train-btn');
                alertContainer.classList.add('disabled-btn');
                alertContainer.disabled = true;
            } else {
                showErrorAlert(data.detail)
            }
        });

        function showBootstrapAlert(predictedLabel, inferenceTime) {
            const alertContainer = document.getElementById('alert-container');

            alertContainer.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>Predict result</strong><br>
                    Predict: ${predictedLabel}<br>
                    Time: ${inferenceTime.toFixed(2)} sec
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        }

        function showErrorAlert(message) {
            const alertContainer = document.getElementById('alert-container');

                alertContainer.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error</strong><br>
                        ${message}<br>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
        }
    </script>
</body>
</html>
